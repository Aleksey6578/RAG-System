#!/usr/bin/env python3
"""
–†–ê–ë–û–ß–ê–Ø –≤–µ—Ä—Å–∏—è rpd_generate.py v5.0

–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Qdrant API (query_points –≤–º–µ—Å—Ç–æ search)
2. –£–ø—Ä–æ—â–µ–Ω –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–æ–¥–µ–ª–∏
3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º
4. –£–ø—Ä–æ—â–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
"""
import json
import requests
import time
import re
import sys
import os
from typing import List, Dict, Optional, Tuple
from qdrant_client import QdrantClient
from qdrant_client.models import PointStruct, Filter, FieldCondition, MatchValue

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
QDRANT = {
    "url": "http://localhost:6333",
    "collection": "rpd_rag"
}
OLLAMA = {
    "embed_url": "http://localhost:11434/api/embeddings",
    "generate_url": "http://localhost:11434/api/generate",
    "embed_model": "bge-m3",
    "llm_model": "qwen2.5:14b"
}
GENERATION = {
    "top_k": 3,
    "sections": [
        "–¶–µ–ª–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã",
        "–§–æ—Ä–º–∏—Ä—É–µ–º—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏",
        "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è",
        "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã",
        "–§–æ–Ω–¥ –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤"
    ]
}
PATHS = {
    "output_rpd": "output_rpd.txt"
}

EMBEDDING_CACHE = {}


def clean_text_simple(text: str) -> str:
    """–ü—Ä–æ—Å—Ç–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞"""
    # –£–¥–∞–ª—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã
    text = re.sub(r' +', ' ', text)
    text = re.sub(r'\n{3,}', '\n\n', text)
    
    # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    lines = [line.strip() for line in text.split('\n') if line.strip()]
    text = '\n'.join(lines)
    
    return text.strip()


def get_embedding(text: str) -> List[float]:
    """–ü–æ–ª—É—á–∏—Ç—å embedding —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    if text in EMBEDDING_CACHE:
        return EMBEDDING_CACHE[text]
    
    query_text = f"query: {text}"
    
    try:
        response = requests.post(
            OLLAMA["embed_url"],
            json={
                "model": OLLAMA["embed_model"],
                "prompt": query_text
            },
            timeout=60
        )
        response.raise_for_status()
        data = response.json()
        
        embedding = data.get("embedding") or data["data"][0]["embedding"]
        EMBEDDING_CACHE[text] = embedding
        return embedding
        
    except Exception as e:
        print(f"  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ embedding: {e}")
        return []


def retrieve_examples(section_title: str, discipline: str, top_k: int = 3) -> List[Dict]:
    """
    –ü–æ–∏—Å–∫ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ Qdrant —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º API
    """
    query = f"{section_title} {discipline}"
    print(f"  üîç –ü–æ–∏—Å–∫: '{query}'")
    
    try:
        q_emb = get_embedding(query)
        if not q_emb:
            return []
        
        client = QdrantClient(url=QDRANT["url"])
        
        # –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º query_points –≤–º–µ—Å—Ç–æ search
        results = client.query_points(
            collection_name=QDRANT["collection"],
            query=q_emb,
            limit=top_k,
            with_payload=True
        )
        
        examples = []
        for point in results.points:
            examples.append({
                'text': point.payload.get('text', ''),
                'section': point.payload.get('section_title', ''),
                'score': point.score
            })
        
        print(f"  ‚úÖ –ù–∞–π–¥–µ–Ω–æ: {len(examples)} –ø—Ä–∏–º–µ—Ä–æ–≤")
        return examples
        
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {e}")
        return []


def build_context(examples: List[Dict], max_chars: int = 1500) -> str:
    """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤"""
    if not examples:
        return "–ü—Ä–∏–º–µ—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –°–æ–∑–¥–∞–π —Ä–∞–∑–¥–µ–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤."
    
    parts = []
    total = 0
    
    for i, ex in enumerate(examples[:2], 1):
        text = ex['text']
        
        # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
        if len(text) > 600:
            text = text[:600] + "..."
        
        part = f"–ü–†–ò–ú–ï–† {i}:\n{text}\n{'='*40}"
        
        if total + len(part) > max_chars:
            break
        
        parts.append(part)
        total += len(part)
    
    return "\n\n".join(parts) if parts else "–ü—Ä–∏–º–µ—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç."


def create_simple_prompt(section_title: str, discipline: str, level: str, context: str) -> str:
    """
    –£–ü–†–û–©–ï–ù–ù–´–ô –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    """
    
    # –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
    examples_map = {
        "–¶–µ–ª–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã": """–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:

–¶–µ–ª—å—é –æ—Å–≤–æ–µ–Ω–∏—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã "–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã" —è–≤–ª—è–µ—Ç—Å—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —É –æ–±—É—á–∞—é—â–∏—Ö—Å—è —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞–Ω–∏–π –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≤—ã–∫–æ–≤ –≤ –æ–±–ª–∞—Å—Ç–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.

–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã:
- –∏–∑—É—á–µ–Ω–∏–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å–Ω–æ–≤ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –∏ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è
- –æ—Å–≤–æ–µ–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≤—ã–∫–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —É–º–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞""",

        "–§–æ—Ä–º–∏—Ä—É–µ–º—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏": """–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:

–ü—Ä–æ—Ü–µ—Å—Å –∏–∑—É—á–µ–Ω–∏—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π:

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏:
–£–ö-1: –°–ø–æ—Å–æ–±–µ–Ω –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –ø–æ–∏—Å–∫, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ —Å–∏–Ω—Ç–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á

–û–±—â–µ–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏:
–û–ü–ö-2: –°–ø–æ—Å–æ–±–µ–Ω –ø–æ–Ω–∏–º–∞—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
–û–ü–ö-3: –°–ø–æ—Å–æ–±–µ–Ω —Ä–µ—à–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏:
–ü–ö-1: –°–ø–æ—Å–æ–±–µ–Ω —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ""",

        "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è": """–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ—Å–≤–æ–µ–Ω–∏—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –æ–±—É—á–∞—é—â–∏–π—Å—è –¥–æ–ª–∂–µ–Ω:

–ó–Ω–∞—Ç—å:
- –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è –∏ –º–µ—Ç–æ–¥—ã –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞
- –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –º–∞—à–∏–Ω–Ω–æ–º—É –æ–±—É—á–µ–Ω–∏—é

–£–º–µ—Ç—å:
- –ø—Ä–∏–º–µ–Ω—è—Ç—å –º–µ—Ç–æ–¥—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á
- –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

–í–ª–∞–¥–µ—Ç—å:
- –Ω–∞–≤—ã–∫–∞–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- –º–µ—Ç–æ–¥–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è""",

        "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã": """–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:

–†–∞–∑–¥–µ–ª 1. –í–≤–µ–¥–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
–¢–µ–º–∞ 1.1. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞
–¢–µ–º–∞ 1.2. –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
–¢–µ–º–∞ 1.3. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

–†–∞–∑–¥–µ–ª 2. –ú–µ—Ç–æ–¥—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è
–¢–µ–º–∞ 2.1. –û–±—É—á–µ–Ω–∏–µ —Å —É—á–∏—Ç–µ–ª–µ–º
–¢–µ–º–∞ 2.2. –û–±—É—á–µ–Ω–∏–µ –±–µ–∑ —É—á–∏—Ç–µ–ª—è
–¢–µ–º–∞ 2.3. –û–±—É—á–µ–Ω–∏–µ —Å –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º

–†–∞–∑–¥–µ–ª 3. –ù–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏
–¢–µ–º–∞ 3.1. –û—Å–Ω–æ–≤—ã –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π
–¢–µ–º–∞ 3.2. –ì–ª—É–±–æ–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ
–¢–µ–º–∞ 3.3. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã""",

        "–§–æ–Ω–¥ –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤": """–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:

–¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏:
- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã (8 —Ä–∞–±–æ—Ç)
- –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (4 —Ä–∞–±–æ—Ç—ã)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (2 —Ç–µ—Å—Ç–∞)
- –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (2 —Ä–∞–±–æ—Ç—ã)

–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è:
- –≠–∫–∑–∞–º–µ–Ω (—É—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ –±–∏–ª–µ—Ç–∞–º)

–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è:
–û—Ç–ª–∏—á–Ω–æ: –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ
–•–æ—Ä–æ—à–æ: –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π —Å –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏
–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ: –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π —Å –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏
–ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ: –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π"""
    }
    
    base_example = examples_map.get(section_title, "")
    
    prompt = f"""–°–æ–∑–¥–∞–π —Ä–∞–∑–¥–µ–ª "{section_title}" –¥–ª—è —Ä–∞–±–æ—á–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã "{discipline}" (—É—Ä–æ–≤–µ–Ω—å: {level}).

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –ü–∏—à–∏ –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –ò—Å–ø–æ–ª—å–∑—É–π –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å
3. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
4. –ê–¥–∞–ø—Ç–∏—Ä—É–π –ø–æ–¥ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É "{discipline}"

{base_example}

{context}

–°–æ–∑–¥–∞–π –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª –¥–ª—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã "{discipline}":"""
    
    return prompt


def generate_section(section_title: str, discipline: str, level: str, context: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–∞ —Å —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
    """
    
    prompt = create_simple_prompt(section_title, discipline, level, context)
    
    print(f"\n  ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...")
    print(f"  üìù –î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞: {len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤")
    
    try:
        response = requests.post(
            OLLAMA["generate_url"],
            json={
                "model": OLLAMA["llm_model"],
                "prompt": prompt,
                "stream": False,  # –û—Ç–∫–ª—é—á–∞–µ–º streaming –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
                "options": {
                    "temperature": 0.3,
                    "top_p": 0.9,
                    "top_k": 40,
                    "num_predict": 800,
                }
            },
            timeout=120
        )
        
        response.raise_for_status()
        data = response.json()
        
        generated_text = data.get("response", "")
        
        if not generated_text:
            print(f"  ‚ö†Ô∏è  –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏")
            print(f"  üìä –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {data}")
            return f"[–û—à–∏–±–∫–∞: –º–æ–¥–µ–ª—å –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ —Ç–µ–∫—Å—Ç]\n\n–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:\n{json.dumps(data, indent=2, ensure_ascii=False)}"
        
        print(f"  ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(generated_text)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –ü—Ä–æ—Å—Ç–∞—è –æ—á–∏—Å—Ç–∫–∞
        cleaned = clean_text_simple(generated_text)
        
        return cleaned
        
    except requests.exceptions.Timeout:
        print(f"  ‚ùå Timeout –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
        return "[–û—à–∏–±–∫–∞: –ø—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ–ª–∏]"
    
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
        return f"[–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}]"


def test_ollama():
    """–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Ollama"""
    print("\nüß™ –¢–ï–°–¢ –ì–ï–ù–ï–†–ê–¶–ò–ò OLLAMA")
    print("=" * 60)
    
    test_prompt = "–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –æ —Ü–µ–ª—è—Ö –∏–∑—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∏ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):"
    
    try:
        response = requests.post(
            OLLAMA["generate_url"],
            json={
                "model": OLLAMA["llm_model"],
                "prompt": test_prompt,
                "stream": False,
                "options": {
                    "temperature": 0.3,
                    "num_predict": 200,
                }
            },
            timeout=60
        )
        
        data = response.json()
        text = data.get("response", "")
        
        if text:
            print(f"‚úÖ –ú–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç!")
            print(f"–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:\n{text[:200]}")
            return True
        else:
            print(f"‚ùå –ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
            print(f"–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç: {json.dumps(data, indent=2, ensure_ascii=False)}")
            return False
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: {e}")
        return False


def main(config_path: Optional[str] = None):
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞
    if config_path is None:
        if os.path.exists("config.json"):
            config_path = "config.json"
        else:
            cfg = {"discipline": "–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã", "level": "–±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç"}
    
    if config_path:
        with open(config_path, encoding="utf-8") as f:
            cfg = json.load(f)
    
    discipline = cfg.get("discipline", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞")
    level = cfg.get("level", "–±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç")
    
    print(f"\n{'='*60}")
    print(f"–ì–ï–ù–ï–†–ê–¶–ò–Ø –†–ü–î v5.0 (–†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø)")
    print(f"{'='*60}")
    print(f"–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞: {discipline}")
    print(f"–£—Ä–æ–≤–µ–Ω—å: {level}")
    print(f"–ú–æ–¥–µ–ª—å: {OLLAMA['llm_model']}")
    print(f"{'='*60}\n")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...")
    
    # Ollama
    try:
        response = requests.get("http://localhost:11434/api/tags", timeout=5)
        print("  ‚úÖ Ollama –¥–æ—Å—Ç—É–ø–µ–Ω")
    except:
        print("  ‚ùå Ollama –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: ollama serve")
        return
    
    # Qdrant
    try:
        client = QdrantClient(url=QDRANT["url"])
        if not client.collection_exists(QDRANT["collection"]):
            print(f"  ‚ùå –ö–æ–ª–ª–µ–∫—Ü–∏—è '{QDRANT['collection']}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
            return
        
        info = client.get_collection(QDRANT["collection"])
        print(f"  ‚úÖ Qdrant: –∫–æ–ª–ª–µ–∫—Ü–∏—è '{QDRANT['collection']}' ({info.points_count} —Ç–æ—á–µ–∫)")
    except Exception as e:
        print(f"  ‚ö†Ô∏è  Qdrant –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")
        print(f"  ‚ö†Ô∏è  –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–∑ –±–∞–∑—ã")
    
    # –¢–µ—Å—Ç –º–æ–¥–µ–ª–∏
    if not test_ollama():
        print("\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ú–æ–¥–µ–ª—å –Ω–µ –ø—Ä–æ—à–ª–∞ —Ç–µ—Å—Ç!")
        print("–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
        print("  1. –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ollama pull qwen2.5:14b")
        print("  2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏")
        print("  3. –ü—Ä–æ–±–ª–µ–º—ã —Å Ollama")
        
        response = input("\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é? (y/n): ")
        if response.lower() != 'y':
            return
    
    print()
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤
    result_sections = []
    
    for idx, section_title in enumerate(GENERATION["sections"], 1):
        print(f"\n{'='*60}")
        print(f"–†–ê–ó–î–ï–õ {idx}/{len(GENERATION['sections'])}: {section_title}")
        print(f"{'='*60}")
        
        # Retrieval
        examples = retrieve_examples(section_title, discipline)
        context = build_context(examples)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
        text = generate_section(section_title, discipline, level, context)
        
        result_sections.append({
            "title": section_title,
            "text": text
        })
        
        print(f"  üìä –î–ª–∏–Ω–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤, {len(text.split())} —Å–ª–æ–≤")
        
        # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
        if idx < len(GENERATION["sections"]):
            time.sleep(1)
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    print(f"\n{'='*60}")
    print("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...")
    
    output_lines = [
        "–†–ê–ë–û–ß–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê –î–ò–°–¶–ò–ü–õ–ò–ù–´",
        "",
        f"–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞: {discipline}",
        f"–£—Ä–æ–≤–µ–Ω—å: {level}",
        "",
        "="*60,
        ""
    ]
    
    for section in result_sections:
        output_lines.append(f"\n## {section['title']}\n")
        output_lines.append(section['text'])
        output_lines.append("\n")
    
    with open(PATHS["output_rpd"], "w", encoding="utf-8") as f:
        f.write("\n".join(output_lines))
    
    print(f"\n{'='*60}")
    print(f"‚úÖ –ì–ï–ù–ï–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê")
    print(f"{'='*60}")
    print(f"  üìÑ –§–∞–π–ª: {PATHS['output_rpd']}")
    print(f"  üìä –†–∞–∑–¥–µ–ª–æ–≤: {len(result_sections)}")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total_chars = sum(len(s['text']) for s in result_sections)
    total_words = sum(len(s['text'].split()) for s in result_sections)
    
    print(f"  üìà –í—Å–µ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤: {total_chars}")
    print(f"  üìà –í—Å–µ–≥–æ —Å–ª–æ–≤: {total_words}")
    print(f"{'='*60}\n")


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("üìù –ò—Å–ø–æ–ª—å–∑—É–µ–º config.json –∏–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        main(None)
    else:
        main(sys.argv[1])
